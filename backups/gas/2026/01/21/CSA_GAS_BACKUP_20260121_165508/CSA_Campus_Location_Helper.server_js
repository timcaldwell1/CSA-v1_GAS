/**
 * @file_name: CSA_Campus_Location_Helper.gs
 * @title: CSA Campus Location Helper
 * @version: v1.0.0
 * @Org_date_time: 2026-01-06
 * @Last Updated: 2026-01-06 11:12 MST
 * @authors:
 *   Tim Caldwell,
 *   ChatGPT, DEV013
 *
 * @description:
 *   Read-only helper to retrieve canonical campus latitude/longitude
 *   from the test3_safety_zones sheet.
 *
 *   Applies to:
 *     - QA / mock data generation
 *     - Production defaults when MOCK_MODE = FALSE
 *
 *   Designed to be future-proof for campus relocation and
 *   multi-campus scaling without requiring code changes.
 *
 * @notes:
 *   - Read-only
 *   - No schema changes
 *   - No UI logic
 *   - Fail-fast on malformed or missing data
 */
 
function CSA_GetActiveCampusLatLng_() {
  const SHEET_NAME = 'test3_safety_zones';
  const TARGET_ZONE_NAME = 'Laveen'; // logical campus identifier

  const ss = SpreadsheetApp.getActive();
  const sheet = ss.getSheetByName(SHEET_NAME);
  if (!sheet) {
    throw new Error('CSA_GetActiveCampusLatLng_: Sheet not found: ' + SHEET_NAME);
  }

  const values = sheet.getDataRange().getValues();
  if (values.length < 2) {
    throw new Error('CSA_GetActiveCampusLatLng_: No zone data rows present');
  }

  const header = values[0];
  const rows = values.slice(1);

  const idx = {
    zone_name: header.indexOf('zone_name'),
    center_lat: header.indexOf('center_lat'),
    center_lon: header.indexOf('center_lon'),
    active: header.indexOf('active')
  };

  // Validate required columns
  Object.keys(idx).forEach(k => {
    if (idx[k] === -1) {
      throw new Error('CSA_GetActiveCampusLatLng_: Missing required column: ' + k);
    }
  });

  for (let i = 0; i < rows.length; i++) {
    const r = rows[i];

    if (
      r[idx.zone_name] === TARGET_ZONE_NAME &&
      String(r[idx.active]).toUpperCase() === 'TRUE'
    ) {
      const lat = Number(r[idx.center_lat]);
      const lng = Number(r[idx.center_lon]);

      if (!isFinite(lat) || !isFinite(lng)) {
        throw new Error(
          'CSA_GetActiveCampusLatLng_: Invalid lat/lng for zone ' + TARGET_ZONE_NAME
        );
      }

      return {
        zone_name: r[idx.zone_name],
        lat: lat,
        lng: lng
      };
    }
  }

  throw new Error(
    'CSA_GetActiveCampusLatLng_: Active campus not found for zone: ' +
      TARGET_ZONE_NAME
  );
}
