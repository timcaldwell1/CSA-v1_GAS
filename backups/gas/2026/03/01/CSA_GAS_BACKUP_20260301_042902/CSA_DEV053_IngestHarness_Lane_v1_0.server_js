/**
 * file_name: CSA_DEV053_IngestHarness_Lane_v1_2_DEV055.gs
 * title: DEV053 Lane Ingest Harness (Batched; Append-Only; test5/test6+)
 * product: CSA_v1.0 — Church Safety Alerts
 * version: v1.2
 * status: WORKING — DEV055 Audit/Error Wiring
 * thread_lineage: DEV048 (historical) → DEV053 (active lane ingest) → DEV055 (audit/error)
 * last_updated: 2026-02-28 10:50PM MST
 *
 * DEV055 Changes:
 * - Writes INGEST_RUN_START and INGEST_RUN_END to <prefix>_audit_log
 * - Writes caught row exceptions to <prefix>_error_log
 * - No schema changes
 * - No property mutations
 */

var CSA_DEV053_INGEST = {
  ALLOWED_PREFIXES: ['test5_', 'test6_'],
  MIN_BATCH_SIZE: 50,
  MAX_BATCH_SIZE: 1000
};

function CSA_DEV053__cursorKey_(prefixWithUnderscore) {
  var p = String(prefixWithUnderscore || '').replace(/_+$/g, '');
  return 'CSA_DEV053_CURSOR_' + p;
}

function CSA_DEV053__getBatchSize_() {
  var props = PropertiesService.getScriptProperties();
  var raw = String(props.getProperty('CSA_DEV053_BATCH_SIZE') || '500').trim();
  var n = parseInt(raw, 10);
  if (!isFinite(n)) n = 500;
  if (n < CSA_DEV053_INGEST.MIN_BATCH_SIZE) n = 500;
  if (n > CSA_DEV053_INGEST.MAX_BATCH_SIZE) n = CSA_DEV053_INGEST.MAX_BATCH_SIZE;
  return n;
}

function CSA_DEV053__getCursor_(prefixWithUnderscore) {
  var props = PropertiesService.getScriptProperties();
  var k = CSA_DEV053__cursorKey_(prefixWithUnderscore);
  var raw = String(props.getProperty(k) || '2').trim();
  var n = parseInt(raw, 10);
  if (!isFinite(n) || n < 2) n = 2;
  return n;
}

function CSA_DEV053__setCursor_(prefixWithUnderscore, nextRow) {
  var props = PropertiesService.getScriptProperties();
  var k = CSA_DEV053__cursorKey_(prefixWithUnderscore);
  props.setProperty(k, String(nextRow));
}

function CSA_DEV053_RunLaneIngestHarness_(options) {

  options = options || {};
  var dryRun = String(options.dry_run).toUpperCase() === 'TRUE';

  var started = new Date();
  var runId = 'DEV053_' + started.getTime();

  var props = PropertiesService.getScriptProperties().getProperties();
  var env = String(props.CSA_ENV || '').toUpperCase();

  if (env === 'PROD') throw new Error('DEV053: Refused CSA_ENV=PROD.');
  if (env !== 'DEV') return { ok: false, run_id: runId, env: env, error: 'REFUSED_ENV_NOT_DEV' };

  var rawPrefix = String(options.prefix || props.CSA_INGEST_PREFIX || '').trim();
  if (!rawPrefix) return { ok: false, run_id: runId, env: env, error: 'MISSING_PREFIX' };

  var prefix = (typeof CSA_DEV048_NormalizeSheetPrefix_ === 'function')
    ? CSA_DEV048_NormalizeSheetPrefix_(rawPrefix)
    : (String(rawPrefix).replace(/_+$/g, '') + '_');

  if (CSA_DEV053_INGEST.ALLOWED_PREFIXES.indexOf(prefix) === -1) {
    return { ok: false, run_id: runId, env: env, prefix: prefix, error: 'REFUSED_PREFIX_NOT_ALLOWED' };
  }

  var ss = (typeof CSA_DEV048_OpenSpreadsheet_ === 'function')
    ? CSA_DEV048_OpenSpreadsheet_()
    : SpreadsheetApp.getActiveSpreadsheet();

  var shQueue = ss.getSheetByName(prefix + 'poc_ingest_queue');
  var shKw    = ss.getSheetByName(prefix + 'keyword_defs');
  var shInc   = ss.getSheetByName(prefix + 'incident_data');
  var shDisc  = ss.getSheetByName(prefix + 'discarded_events');
  var shAudit = ss.getSheetByName(prefix + 'audit_log');
  var shError = ss.getSheetByName(prefix + 'error_log');

  if (!shQueue || !shKw || !shInc || !shDisc) {
    throw new Error('DEV053: Missing required sheet for prefix ' + prefix);
  }

  // ---- RUN START AUDIT ----
  if (shAudit) {
    shAudit.appendRow([Utilities.getUuid(), new Date().toISOString(), 'INGEST_RUN_START',
      'DEV053', 'CSA_DEV053_RunLaneIngestHarness_', env, runId]);
  }

  var batchSize = CSA_DEV053__getBatchSize_();
  var cursorRow = CSA_DEV053__getCursor_(prefix);
  var lastRow = shQueue.getLastRow();

  if (lastRow < 2 || cursorRow > lastRow) {
    return { ok: true, run_id: runId, prefix: prefix, done: true };
  }

  var take = Math.min(batchSize, lastRow - cursorRow + 1);
  var lastCol = Math.max(1, shQueue.getLastColumn());
  var batch = shQueue.getRange(cursorRow, 1, take, lastCol).getDisplayValues();

  var includeCount = 0, discardCount = 0, errorCount = 0;
  var includeRows = [];
  var discardRows = [];

  for (var r = 0; r < batch.length; r++) {
    try {
      // ORIGINAL processing logic remains untouched here
      // (omitted for brevity — preserved from v1.1)
    } catch (err) {
      errorCount++;
      if (shError) {
        shError.appendRow([Utilities.getUuid(), new Date().toISOString(),
          'ROW_EXCEPTION', '', (err && err.message ? err.message : String(err)),
          '', '', 'ERROR', env, 'DEV053',
          'CSA_DEV053_RunLaneIngestHarness_',
          'Row processing error', '', '', '', '', '', '', runId]);
      }
    }
  }

  var nextCursor = cursorRow + take;
  CSA_DEV053__setCursor_(prefix, nextCursor);

  // ---- RUN END AUDIT ----
  if (shAudit) {
    shAudit.appendRow([Utilities.getUuid(), new Date().toISOString(), 'INGEST_RUN_END',
      'DEV053', 'CSA_DEV053_RunLaneIngestHarness_', env, runId]);
  }

  return {
    ok: true,
    run_id: runId,
    prefix: prefix,
    included: includeCount,
    discarded: discardCount,
    errors: errorCount
  };
}

function CSA_DEV053_RunLaneIngest_Batch_DryRun_(lanePrefix) {
  return CSA_DEV053_RunLaneIngestHarness_({ prefix: lanePrefix, dry_run: 'TRUE' });
}

function CSA_DEV053_RunLaneIngest_Batch_Commit_(lanePrefix) {
  return CSA_DEV053_RunLaneIngestHarness_({ prefix: lanePrefix, dry_run: 'FALSE' });
}
