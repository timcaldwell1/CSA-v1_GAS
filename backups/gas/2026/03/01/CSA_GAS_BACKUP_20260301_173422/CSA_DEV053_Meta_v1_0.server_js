/**
 * file_name: CSA_DEV053_Meta_v1_0.gs
 * title: DEV053 Prefix Meta Enforcement
 * product: CSA_v1.0 â€” Church Safety Alerts
 * version: 1.0
 * status: WORKING
 * thread_lineage: DEV053
 */

function CSA_DEV053_EnsureMetaSheet_(prefix) {
  const ss = SpreadsheetApp.getActive();
  const name = prefix + '_meta';
  let sheet = ss.getSheetByName(name);

  if (!sheet) {
    sheet = ss.insertSheet(name);
    sheet.getRange(1,1,1,2).setValues([['key','value']]);
    sheet.getRange(2,1,4,2).setValues([
      ['schema_version','1.3.0'],
      ['created_at', new Date().toISOString()],
      ['last_migrated_at', new Date().toISOString()],
      ['owner','CSA_v1']
    ]);
  }

  return sheet;
}

function CSA_DEV053_AssertSchemaVersion_(prefix, expected) {
  const ss = SpreadsheetApp.getActive();
  const sheet = ss.getSheetByName(prefix + '_meta');
  if (!sheet) throw new Error('Meta sheet missing for prefix: ' + prefix);

  const data = sheet.getRange(2,1,sheet.getLastRow()-1,2).getValues();
  const map = {};
  data.forEach(r => map[r[0]] = r[1]);

  if (map['schema_version'] !== expected) {
    throw new Error(
      'Schema mismatch. Expected ' + expected +
      ', found ' + map['schema_version']
    );
  }
}