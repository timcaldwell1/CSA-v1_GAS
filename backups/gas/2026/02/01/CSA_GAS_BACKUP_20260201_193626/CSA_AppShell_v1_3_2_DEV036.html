<!--
  @file_name: CSA_AppShell_v1_3_2_DEV036.html
  @title: CSA WebApp AppShell (DEV036 — UI Timestamp Consumption + Sync Restore)
  @version: v1.3.2-DEV036
  @Org_date_time: 2026-01-30
  @Last Updated: 2026-01-30 08:55 MST
  @authors:
    Tim Caldwell,
    ChatGPT, DEV036

  @description:
    UI-only:
      - Sort by timestamp_epoch_ms (invariant across timezone display)
      - Render timestamps via Intl.DateTimeFormat
      - Toggle Local | MST (session-only, display-only)
      - Badge on cards + marker popups
      - Restore card ↔ marker selection sync
      - Restore card description rendering

  @notes:
    - No server/router/sheet changes
    - Never parse timestamp_display or timestamp_iso for correctness
-->

<!DOCTYPE html>
<html>
  <head>
    <base target="_top" />
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>CSA — Safety Dashboard</title>

    <!-- Leaflet -->
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
      crossorigin=""
    />
    <script
      src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
      crossorigin=""
    ></script>

    <!-- Leaflet MarkerCluster -->
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css"
    />
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css"
    />
    <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

    <style>
      :root {
        --bg: #0f172a;
        --panel: #0b1220;
        --panel2: #111b2f;
        --text: #e5e7eb;
        --muted: #cbd5e1;
        --border: rgba(255, 255, 255, 0.10);
        --accent: #5eead4;
        --accent2: rgba(94, 234, 212, 0.16);
        --danger: #d14a42;
      }

      body {
        margin: 0;
        font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
        background: var(--bg);
        color: var(--text);
      }

      .app {
        display: grid;
        grid-template-columns: 1.3fr 0.7fr;
        height: 100vh;
        gap: 0;
      }

      #map {
        width: 100%;
        height: 100vh;
      }

      .sidebar {
        height: 100vh;
        background: var(--panel);
        border-left: 1px solid var(--border);
        display: grid;
        grid-template-rows: auto 1fr auto;
      }

      .header {
        padding: 14px 14px 10px 14px;
        border-bottom: 1px solid var(--border);
        background: linear-gradient(180deg, rgba(255,255,255,0.04), rgba(255,255,255,0.00));
      }

      .row {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 10px;
      }

      .title {
        margin: 0;
        font-size: 16px;
        font-weight: 800;
        letter-spacing: 0.2px;
      }

      .subtitle {
        margin: 6px 0 0 0;
        font-size: 12px;
        color: var(--muted);
      }

      .live {
        display: inline-block;
        padding: 4px 8px;
        border-radius: 999px;
        background: rgba(209, 74, 66, 0.16);
        border: 1px solid rgba(209, 74, 66, 0.5);
        color: var(--danger);
        font-size: 11px;
        font-weight: 800;
        white-space: nowrap;
      }

      .tz-row {
        display: flex;
        gap: 10px;
        margin-top: 12px;
        align-items: center;
      }

      .tz-btn {
        font-size: 12px;
        padding: 8px 14px;
        border-radius: 10px;
        border: 1px solid var(--border);
        background: rgba(255,255,255,0.03);
        color: var(--text);
        cursor: pointer;
        user-select: none;
      }

      .tz-btn.active {
        border-color: rgba(94,234,212,0.75);
        background: rgba(94,234,212,0.10);
        color: var(--accent);
      }

      .cards {
        padding: 12px 14px 14px 14px;
        overflow: auto;
      }

      .card {
        border: 1px solid var(--border);
        background: rgba(255,255,255,0.03);
        border-radius: 12px;
        padding: 12px;
        margin-bottom: 10px;
        cursor: pointer;
      }

      .card:hover { background: rgba(255,255,255,0.05); }

      .card.selected {
        outline: 2px solid rgba(94,234,212,0.55);
        background: rgba(94,234,212,0.08);
      }

      .card h3 {
        margin: 0 0 8px 0;
        font-size: 13px;
        font-weight: 800;
      }

      .desc {
        font-size: 12px;
        color: var(--text);
        opacity: 0.98;
        line-height: 1.35;
        margin: 0 0 10px 0;
        white-space: normal;
        word-break: break-word;
      }

      .meta {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 12px;
        color: var(--muted);
        line-height: 1.2;
        flex-wrap: wrap;
      }

      .badge {
        display: inline-block;
        padding: 2px 8px;
        border-radius: 999px;
        border: 1px solid var(--border);
        background: rgba(255,255,255,0.03);
        font-size: 11px;
        color: var(--muted);
      }

      .badge.mode {
        border-color: rgba(94,234,212,0.35);
        background: var(--accent2);
        color: var(--accent);
        font-weight: 800;
      }

      .footer {
        padding: 10px 14px;
        border-top: 1px solid var(--border);
        color: var(--muted);
        font-size: 11px;
        background: rgba(255,255,255,0.02);
        display: flex;
        gap: 10px;
        justify-content: space-between;
        align-items: center;
      }

      .foot-left { overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
      .foot-right { white-space: nowrap; opacity: 0.95; }

      @media (max-width: 980px) {
        .app {
          grid-template-columns: 1fr;
          grid-template-rows: 58vh 42vh;
        }
        #map { height: 58vh; }
        .sidebar {
          height: 42vh;
          border-left: none;
          border-top: 1px solid var(--border);
        }
      }
    </style>
  </head>

  <body>
    <div class="app">
      <div id="map"></div>

      <div class="sidebar">
        <div class="header">
          <div class="row">
            <div>
              <h1 class="title">CSA — Safety Dashboard</h1>
              <p class="subtitle">Read-only situational awareness</p>
            </div>
            <span class="live" title="Execution marker">DEV036 LIVE</span>
          </div>

          <div class="tz-row" aria-label="Timezone display toggle">
            <button id="btnLocal" class="tz-btn active" type="button">Local</button>
            <button id="btnMST" class="tz-btn" type="button">MST</button>
          </div>
        </div>

        <div class="cards" id="cards"></div>

        <div class="footer">
          <div class="foot-left" id="footerLeft">Status: Ready</div>
          <div class="foot-right" id="footerRight">mode=Local</div>
        </div>
      </div>
    </div>

    <script>
      // ----------------------------
      // State
      // ----------------------------
      const DEFAULT_CENTER = [33.4484, -112.0740];
      const DEFAULT_ZOOM = 11;
      const TZ_MST = "America/Phoenix";

      let tzMode = "local"; // session-only display mode
      let map = null;
      let clusterGroup = null;

      const markerById = new Map(); // id -> marker
      const recById = new Map();    // id -> record
      const cardById = new Map();   // id -> element
      let selectedId = null;

      const cardsEl = document.getElementById("cards");
      const footerLeft = document.getElementById("footerLeft");
      const footerRight = document.getElementById("footerRight");
      const btnLocal = document.getElementById("btnLocal");
      const btnMST = document.getElementById("btnMST");

      // ----------------------------
      // Utils
      // ----------------------------
      function setFooter(left, right) {
        if (left != null) footerLeft.textContent = left;
        if (right != null) footerRight.textContent = right;
      }

      function toNumber(v) {
        const n = Number(v);
        return Number.isFinite(n) ? n : null;
      }

      function safeStr(v) {
        return (v == null) ? "" : String(v);
      }

      function modeLabel() {
        return (tzMode === "mst") ? "MST" : "Local";
      }

      function getEpochMs(rec) {
        // Canonical: timestamp_epoch_ms (DEV034)
        const epoch = toNumber(rec.timestamp_epoch_ms);
        if (epoch !== null) return epoch;

        // Fail-open: numeric fallback only
        const sortEpoch = toNumber(rec.timestamp_sort);
        if (sortEpoch !== null) return sortEpoch;

        return null;
      }

      function formatEpoch(epochMs) {
        if (!Number.isFinite(epochMs)) return "—";
        const opts = {
          year: "numeric",
          month: "2-digit",
          day: "2-digit",
          hour: "2-digit",
          minute: "2-digit"
        };
        if (tzMode === "mst") opts.timeZone = TZ_MST;
        return new Intl.DateTimeFormat("en-US", opts).format(new Date(epochMs));
      }

      function makeStableId(rec, idx) {
        // Force a stable, string ID for both cards and markers.
        // Prefer id_a, then id, then hash_id, then deterministic fallback.
        const raw =
          rec.id_a ?? rec.id ?? rec.hash_id ?? rec.incident_id ?? rec.uid ?? ("rec_" + (idx + 1));
        return String(raw);
      }

      function getTitle(rec) {
        return rec.incident_type || rec.title || rec.type || rec.category || "Incident";
      }

      function getDesc(rec) {
        // Your payload shows description is present. Render it. Period.
        const d = rec.description;
        return (d == null) ? "" : String(d);
      }

      function escapeHtml(s) {
        return safeStr(s)
          .replaceAll("&", "&amp;")
          .replaceAll("<", "&lt;")
          .replaceAll(">", "&gt;")
          .replaceAll('"', "&quot;")
          .replaceAll("'", "&#39;");
      }

      function clearUI() {
        markerById.clear();
        recById.clear();
        cardById.clear();
        cardsEl.innerHTML = "";
        selectedId = null;
        if (clusterGroup) clusterGroup.clearLayers();
      }

      // ----------------------------
      // Map init
      // ----------------------------
      function initMap() {
        map = L.map("map", { zoomControl: true }).setView(DEFAULT_CENTER, DEFAULT_ZOOM);

        L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
          maxZoom: 19,
          attribution: "&copy; OpenStreetMap contributors"
        }).addTo(map);

        clusterGroup = L.markerClusterGroup({
          showCoverageOnHover: false,
          spiderfyOnMaxZoom: true,
          disableClusteringAtZoom: 17
        });

        map.addLayer(clusterGroup);
      }

      // ----------------------------
      // Selection sync
      // ----------------------------
      function setSelected(id) {
        if (!id) return;

        // unselect prior
        if (selectedId && cardById.has(selectedId)) {
          cardById.get(selectedId).classList.remove("selected");
        }

        selectedId = id;

        // select card + scroll
        if (cardById.has(id)) {
          const card = cardById.get(id);
          card.classList.add("selected");
          card.scrollIntoView({ block: "nearest", behavior: "smooth" });
        }

        // open marker + pan
        const marker = markerById.get(id);
        if (marker && map) {
          if (clusterGroup && clusterGroup.zoomToShowLayer) {
            clusterGroup.zoomToShowLayer(marker, () => {
              marker.openPopup();
              map.panTo(marker.getLatLng(), { animate: true });
            });
          } else {
            marker.openPopup();
            map.panTo(marker.getLatLng(), { animate: true });
          }
        }
      }

      // ----------------------------
      // Rendering
      // ----------------------------
      function buildPopupHtml(rec, id) {
        const title = escapeHtml(getTitle(rec));
        const desc = escapeHtml(getDesc(rec));
        const ts = escapeHtml(formatEpoch(getEpochMs(rec)));
        const badge = `<span class="badge mode" data-role="mode-badge" data-id="${escapeHtml(id)}">${escapeHtml(modeLabel())}</span>`;

        const descLine = desc
          ? `<div style="margin-top:6px; color:#e5e7eb; opacity:0.98; font-size:12px; line-height:1.35;">${desc}</div>`
          : "";

        return `
          <div>
            <div style="font-weight:800; font-size:13px;">${title}</div>
            ${descLine}
            <div style="margin-top:8px; color:#cbd5e1; font-size:12px;">
              <span data-role="ts" data-id="${escapeHtml(id)}">${ts}</span>
              ${badge}
            </div>
          </div>
        `;
      }

      function addMarker(rec, id) {
        const lat = toNumber(rec.latitude);
        const lng = toNumber(rec.longitude);
        if (lat === null || lng === null || !clusterGroup) return;

        const marker = L.marker([lat, lng]);
        marker.bindPopup(buildPopupHtml(rec, id));
        marker.on("click", () => setSelected(id));

        clusterGroup.addLayer(marker);
        markerById.set(id, marker);
      }

      function addCard(rec, id) {
        const card = document.createElement("div");
        card.className = "card";
        card.dataset.id = id;

        const h3 = document.createElement("h3");
        h3.textContent = getTitle(rec);

        const desc = document.createElement("div");
        desc.className = "desc";

        const d = getDesc(rec);
        // If payload truly always has description, you'll never see the fallback.
        desc.textContent = d ? d : "(missing description)";

        const meta = document.createElement("div");
        meta.className = "meta";

        const tsSpan = document.createElement("span");
        tsSpan.dataset.role = "ts";
        tsSpan.dataset.id = id;
        tsSpan.textContent = formatEpoch(getEpochMs(rec));

        const badge = document.createElement("span");
        badge.className = "badge mode";
        badge.dataset.role = "mode-badge";
        badge.dataset.id = id;
        badge.textContent = modeLabel();

        meta.appendChild(tsSpan);
        meta.appendChild(badge);

        card.appendChild(h3);
        card.appendChild(desc);
        card.appendChild(meta);

        card.addEventListener("click", () => setSelected(id));

        cardsEl.appendChild(card);
        cardById.set(id, card);
      }

      function rerenderTimesAndBadges() {
        // Update card timestamps
        document.querySelectorAll('[data-role="ts"]').forEach(el => {
          const id = el.dataset.id;
          const rec = recById.get(id);
          if (!rec) return;
          el.textContent = formatEpoch(getEpochMs(rec));
        });

        // Update badges
        document.querySelectorAll('[data-role="mode-badge"]').forEach(el => {
          el.textContent = modeLabel();
        });

        // Update popup content too (open/closed)
        markerById.forEach((marker, id) => {
          const rec = recById.get(id);
          if (!rec) return;
          marker.setPopupContent(buildPopupHtml(rec, id));
        });

        setFooter(null, "mode=" + modeLabel());
      }

      // ----------------------------
      // Toggle
      // ----------------------------
      function setTzMode(mode) {
        tzMode = (mode === "mst") ? "mst" : "local";
        btnLocal.classList.toggle("active", tzMode === "local");
        btnMST.classList.toggle("active", tzMode === "mst");
        rerenderTimesAndBadges();
      }

      btnLocal.addEventListener("click", () => setTzMode("local"));
      btnMST.addEventListener("click", () => setTzMode("mst"));

      // ----------------------------
      // Data load
      // ----------------------------
      function normalizePayload(payload) {
        if (payload && typeof payload === "object" && Array.isArray(payload.incidents)) return payload.incidents;
        if (Array.isArray(payload)) return payload;
        return [];
      }

      function loadIncidents() {
        setFooter("Status: Loading…", "mode=" + modeLabel());

        google.script.run
          .withSuccessHandler(onLoaded)
          .withFailureHandler(onFailed)
          .CSA_WebApp_GetIncidentData();
      }

      function onLoaded(payload) {
        const raw = normalizePayload(payload);
        clearUI();

        if (!raw || raw.length === 0) {
          setFooter("Status: No incidents returned", "mode=" + modeLabel());
          return;
        }

        // Normalize records (stable IDs, store in recById)
        const normalized = raw.map((rec, idx) => {
          const r = (rec && typeof rec === "object") ? rec : {};
          const id = makeStableId(r, idx);
          r._ui_id = id;
          return r;
        });

        // Sort by epoch only (invariant across display tz)
        normalized.sort((a, b) => {
          const ea = getEpochMs(a);
          const eb = getEpochMs(b);
          const na = (ea === null) ? -Infinity : ea;
          const nb = (eb === null) ? -Infinity : eb;
          return nb - na;
        });

        // Render
        normalized.forEach((rec) => {
          const id = rec._ui_id;
          recById.set(id, rec);
          addMarker(rec, id);
          addCard(rec, id);
        });

        // Fit bounds
        try {
          if (clusterGroup && clusterGroup.getLayers().length > 0) {
            const bounds = clusterGroup.getBounds();
            if (bounds && bounds.isValid()) map.fitBounds(bounds, { padding: [30, 30] });
          }
        } catch {}

        // UI breadcrumb proving what rendered
        const sample = normalized[0];
        const sampleDesc = getDesc(sample);
        setFooter(
          `Status: Loaded (${normalized.length}) | first_desc_len=${sampleDesc.length}`,
          "mode=" + modeLabel()
        );
      }

      function onFailed(err) {
        clearUI();
        const msg = (err && err.message) ? err.message : String(err || "unknown");
        setFooter("Status: Load failed: " + msg, "mode=" + modeLabel());
      }

      // ----------------------------
      // Boot
      // ----------------------------
      document.addEventListener("DOMContentLoaded", () => {
        initMap();
        loadIncidents();
      });
    </script>
  </body>
</html>
